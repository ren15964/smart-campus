import{g as oe,a as re,u as se,b as ne}from"./resource-DrvMw_ac.js";import{a as ue}from"./course-CglI6mUT.js";import{A as ie}from"./AppEmpty-BAEE0X2a.js";import{_ as de,p as ce,s as pe,c as I,a,w as t,E as i,r as d,h,g as x,k as me,S as fe,o as y,f,U as ve,I as z,b as V,t as ge,G as he,H as _e,j as $,z as B,Q as ye}from"./index-jCaZfwQD.js";const be={class:"resource-manage-container"},we={class:"card-header"},Ve={class:"pagination-container"},Ce={class:"dialog-footer"},ke={__name:"ResourceManage",setup(ze){const C=h([]),R=h([]),N=h(!1),v=x({chapter:"",keyword:""}),n=x({current:1,size:10,total:0}),U=me(()=>{const l=(n.current-1)*n.size,e=l+n.size;return C.value.slice(l,e)});ce(()=>[n.current,n.size,C.value.length],()=>{R.value=U.value});const _=h(!1),c=h(!1),k=h(null),T=h([]),r=x({id:null,scheduleId:null,resourceName:"",resourceType:"document",chapter:"",description:"",filePath:""}),p=h([]),D={scheduleId:[{required:!0,message:"请选择所属课程",trigger:"change"}],resourceName:[{required:!0,message:"请输入资源名称",trigger:"blur"}],resourceType:[{required:!0,message:"请选择资源类型",trigger:"change"}],file:[{required:!1,message:"请上传文件",trigger:"change",validator:(l,e,s)=>{!c.value&&!r.filePath&&p.value.length===0?s(new Error(l.message)):s()}}]},b=async()=>{N.value=!0;try{const l=await oe({current:n.current,size:n.size,...v});l.code===200&&(C.value=Array.isArray(l.data)?l.data:[],n.total=C.value.length,R.value=U.value)}catch(l){console.error("获取资源列表失败:",l),i.error("获取资源失败，请稍后再试")}finally{N.value=!1}},L=async()=>{if(!(T.value.length>0))try{const l=await ue({current:1,size:1e3});l.code===200&&(T.value=l.data.records)}catch(l){console.error("获取教师课程选项失败:",l)}},M=()=>{n.current=1,b()},F=()=>{v.chapter="",v.keyword="",n.current=1,b()},S=l=>{n.size=l},j=l=>{n.current=l},O=()=>{c.value=!1,_.value=!0,B(()=>{var l;(l=k.value)==null||l.resetFields(),Object.assign(r,{id:null,scheduleId:null,resourceName:"",resourceType:"document",chapter:"",description:"",filePath:""}),p.value=[]})},A=l=>{c.value=!0,_.value=!0,B(()=>{Object.assign(r,l),p.value=l.filePath?[{name:l.resourceName,url:l.filePath}]:[]})},q=async l=>{ye.confirm(`确定要删除资源《${l.resourceName}》吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{const e=await re(l.id);e.code===200?(i.success("删除成功"),b()):i.error(e.message||"删除失败")}catch(e){console.error("删除失败:",e),i.error("删除失败，请稍后再试")}}).catch(()=>{i.info("已取消删除")})},G=()=>{var l;(l=k.value)==null||l.validate(async e=>{if(e)try{let s;const m=new FormData;if(Object.keys(r).forEach(u=>{u!=="id"&&r[u]!==null&&m.append(u,r[u])}),c.value)s=await se(r.id,r);else{if(p.value.length>0&&p.value[0].raw)m.append("file",p.value[0].raw);else if(!r.filePath){i.error("请上传文件或提供文件路径");return}s=await ne(m)}s.code===200?(i.success(`${c.value?"编辑":"上传"}成功`),_.value=!1,b()):i.error(s.message||`${c.value?"编辑":"上传"}失败`)}catch(s){console.error(`${c.value?"编辑":"上传"}失败:`,s),i.error(`${c.value?"编辑":"上传"}失败，请稍后再试`)}})},H=()=>{var l;(l=k.value)==null||l.resetFields(),Object.assign(r,{id:null,scheduleId:null,resourceName:"",resourceType:"document",chapter:"",description:"",filePath:""}),p.value=[]},Q=(l,e,s)=>{l.code===200?(r.filePath=l.data.filePath,i.success("文件上传成功")):(p.value=[],i.error(l.message||"文件上传失败"))},J=(l,e,s)=>{i.error("文件上传失败，请重试"),console.error("文件上传失败:",l)},K=(l,e)=>{r.filePath=null},W=l=>{const e=l.size/1024/1024<50;return e||i.error("上传附件大小不能超过 50MB!"),e};return pe(()=>{b()}),(l,e)=>{const s=d("el-button"),m=d("el-input"),u=d("el-form-item"),P=d("el-form"),g=d("el-table-column"),X=d("el-table"),Y=d("el-pagination"),Z=d("el-card"),w=d("el-option"),E=d("el-select"),ee=d("el-upload"),le=d("el-dialog"),ae=fe("loading");return y(),I("div",be,[a(Z,{class:"box-card"},{header:t(()=>[V("div",we,[V("span",null,"课程资源管理 - "+ge(l.courseName),1),a(s,{type:"primary",onClick:O},{default:t(()=>[...e[11]||(e[11]=[f("上传资源",-1)])]),_:1})])]),default:t(()=>[a(P,{inline:!0,model:v,class:"search-form"},{default:t(()=>[a(u,{label:"章节"},{default:t(()=>[a(m,{modelValue:v.chapter,"onUpdate:modelValue":e[0]||(e[0]=o=>v.chapter=o),placeholder:"请输入章节",clearable:""},null,8,["modelValue"])]),_:1}),a(u,{label:"资源名称"},{default:t(()=>[a(m,{modelValue:v.keyword,"onUpdate:modelValue":e[1]||(e[1]=o=>v.keyword=o),placeholder:"请输入资源名称",clearable:""},null,8,["modelValue"])]),_:1}),a(u,null,{default:t(()=>[a(s,{type:"primary",onClick:M},{default:t(()=>[...e[12]||(e[12]=[f("查询",-1)])]),_:1}),a(s,{onClick:F},{default:t(()=>[...e[13]||(e[13]=[f("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"]),ve((y(),z(X,{data:R.value,border:"",style:{width:"100%"}},{empty:t(()=>[a(ie,{description:"暂无资源"},{default:t(()=>[a(s,{type:"primary",onClick:F},{default:t(()=>[...e[14]||(e[14]=[f("清空筛选",-1)])]),_:1})]),_:1})]),default:t(()=>[a(g,{prop:"id",label:"ID",width:"80"}),a(g,{prop:"resourceName",label:"资源名称","show-overflow-tooltip":""}),a(g,{prop:"resourceType",label:"类型",width:"100"}),a(g,{prop:"chapter",label:"章节",width:"120"}),a(g,{prop:"description",label:"描述","show-overflow-tooltip":""}),a(g,{prop:"downloadCount",label:"下载量",width:"100"}),a(g,{prop:"createTime",label:"上传时间",width:"180"}),a(g,{label:"操作",width:"180"},{default:t(o=>[a(s,{type:"primary",link:"",onClick:te=>A(o.row)},{default:t(()=>[...e[15]||(e[15]=[f(" 编辑 ",-1)])]),_:1},8,["onClick"]),a(s,{type:"danger",link:"",onClick:te=>q(o.row)},{default:t(()=>[...e[16]||(e[16]=[f(" 删除 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[ae,N.value]]),V("div",Ve,[a(Y,{"current-page":n.current,"onUpdate:currentPage":e[2]||(e[2]=o=>n.current=o),"page-size":n.size,"onUpdate:pageSize":e[3]||(e[3]=o=>n.size=o),"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",total:n.total,onSizeChange:S,onCurrentChange:j},null,8,["current-page","page-size","total"])])]),_:1}),a(le,{modelValue:_.value,"onUpdate:modelValue":e[10]||(e[10]=o=>_.value=o),title:c.value?"编辑资源":"上传资源",width:"600px",onClose:H},{footer:t(()=>[V("span",Ce,[a(s,{onClick:e[9]||(e[9]=o=>_.value=!1)},{default:t(()=>[...e[19]||(e[19]=[f("取消",-1)])]),_:1}),a(s,{type:"primary",onClick:G},{default:t(()=>[...e[20]||(e[20]=[f("确定",-1)])]),_:1})])]),default:t(()=>[a(P,{model:r,rules:D,ref_key:"resourceFormRef",ref:k,"label-width":"100px"},{default:t(()=>[c.value?$("",!0):(y(),z(u,{key:0,label:"所属课程",prop:"scheduleId"},{default:t(()=>[a(E,{modelValue:r.scheduleId,"onUpdate:modelValue":e[4]||(e[4]=o=>r.scheduleId=o),placeholder:"请选择课程",filterable:"",onFocus:L},{default:t(()=>[(y(!0),I(he,null,_e(T.value,o=>(y(),z(w,{key:o.id,label:`${o.courseName} (${o.semester})`,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})),a(u,{label:"资源名称",prop:"resourceName"},{default:t(()=>[a(m,{modelValue:r.resourceName,"onUpdate:modelValue":e[5]||(e[5]=o=>r.resourceName=o)},null,8,["modelValue"])]),_:1}),a(u,{label:"资源类型",prop:"resourceType"},{default:t(()=>[a(E,{modelValue:r.resourceType,"onUpdate:modelValue":e[6]||(e[6]=o=>r.resourceType=o),placeholder:"请选择资源类型"},{default:t(()=>[a(w,{label:"文档",value:"document"}),a(w,{label:"视频",value:"video"}),a(w,{label:"图片",value:"image"}),a(w,{label:"其他",value:"other"})]),_:1},8,["modelValue"])]),_:1}),a(u,{label:"章节",prop:"chapter"},{default:t(()=>[a(m,{modelValue:r.chapter,"onUpdate:modelValue":e[7]||(e[7]=o=>r.chapter=o)},null,8,["modelValue"])]),_:1}),a(u,{label:"描述",prop:"description"},{default:t(()=>[a(m,{modelValue:r.description,"onUpdate:modelValue":e[8]||(e[8]=o=>r.description=o),type:"textarea",rows:"3"},null,8,["modelValue"])]),_:1}),c.value?$("",!0):(y(),z(u,{key:1,label:"文件上传",prop:"file"},{default:t(()=>[a(ee,{class:"upload-demo",action:"/api/file/upload","on-success":Q,"on-error":J,"on-remove":K,"before-upload":W,limit:1,"file-list":p.value},{tip:t(()=>[...e[18]||(e[18]=[V("div",{class:"el-upload__tip",style:{color:"var(--app-text-muted)"}},"可上传各类文件，大小不超过50MB",-1)])]),default:t(()=>[a(s,{type:"primary"},{default:t(()=>[...e[17]||(e[17]=[f("点击上传",-1)])]),_:1})]),_:1},8,["file-list"])]),_:1}))]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},Ue=de(ke,[["__scopeId","data-v-1d0a4517"]]);export{Ue as default};
